image: docker:18.09
services:
- docker:18.09-dind

variables:
  DOCKER_DRIVER: overlay
  SPRING_PROFILES_ACTIVE: gitlab-ci

stages:
- build
- test
- release
- package

maven-build:
  image: maven:3-jdk-8
  stage: build
  script:
  - mvn -Dmaven.test.skip=true package -B > build.log
  - mvn test-compile
  artifacts:
    paths:
    - target/*
    - build.log

maven-test:
  image: maven:3-jdk-8
  stage: test
  script:
  - mvn surefire:test > test.log
  artifacts:
    paths:
    - test.log

maven_release:
  image: openjdk:17
  stage: release
  only:
    - master
  when: manual
  before_script:
    - mkdir -p ~/.ssh/
    - cp $DEPLOY_PRIVATE_KEY ~/.ssh/id_rsa && chmod 600 ~/.ssh/id_rsa
    - cp $KNOWN_HOSTS ~/.ssh/known_hosts
    - apt-get update && apt-get install -y git
    - git config --global user.email "noreply@your.gitlab.host"
    - git config --global user.name "GitLab CI"
    - git checkout -B "$CI_COMMIT_REF_NAME"
  script:
    - ./mvnw release:prepare release:perform -s $SETTINGS_XML



docker-build:
  stage: package
  before_script:
    - export IMAGE=$CI_REGISTRY/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME
    - export WEB_IMAGE=$IMAGE/Petclinic_build
  script:
  - docker login -u $CI_REGISTRY_USER -p $CI_JOB_TOKEN $CI_REGISTRY
    - docker-compose -f docker-compose-ci.yml build
    - docker tag petclinic_pipe:latest $WEB_IMAGE:latest
    - docker images
    - docker push $WEB_IMAGE:latest


